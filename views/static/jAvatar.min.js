var canvasSize=300,iconSize=60,canvas=document.getElementById("jallowPinsCanvas"),copperImage=$("#copper-img"),image=$("#avatar-img"),preview=$(".previewBoxRound"),container=$("#cropper-container"),cropBtn=$(".cropper-btn"),ctx=canvas.getContext("2d"),pixelRatio=getPixelRatio(ctx),canvasRealWidth=canvasSize*pixelRatio,canvasRealHeight=canvasRealWidth,cropper=null;canvas.width=canvasRealWidth,canvas.height=canvasRealHeight;var iconRealSize=iconSize*pixelRatio;function drawAvatar(e){var a=new Image;a.src=e,a.onload=function(){window.EXIF.getData(a,function(){switch(EXIF.getTag(this,"Orientation")){case 3:ctx.rotate(Math.PI),ctx.drawImage(a,-canvasRealWidth,-canvasRealHeight,canvasRealWidth,canvasRealHeight),ctx.rotate(-Math.PI);break;case 6:ctx.rotate(.5*Math.PI),ctx.drawImage(a,0,-canvasRealHeight,canvasRealWidth,canvasRealHeight),ctx.rotate(-.5*Math.PI);break;case 8:ctx.rotate(3*Math.PI/2),ctx.drawImage(a,canvasRealWidth,0,canvasRealWidth,canvasRealHeight),ctx.rotate(-3*Math.PI/2);break;default:ctx.drawImage(a,0,0,canvasRealWidth,canvasRealHeight)}}),drawCanvas2Image(),changeElementVisible(image,!0),changeIconBannerVisible(!0),changeDownloadBtnVisible(!0)}}function drawCanvas2Image(){var e=canvas.toDataURL("image/png");image.attr("src",e)}function drawIconBorder(){ctx.beginPath(),ctx.arc(.675*canvasRealWidth+iconRealSize/2,.675*canvasRealHeight+iconRealSize/2,iconRealSize/2+8,0,2*Math.PI),ctx.fillStyle="#fff",ctx.fill()}function drawIcon(e){var a=new Image;a.src=e,a.onload=function(){drawIconBorder(),ctx.drawImage(a,.675*canvasRealWidth,.675*canvasRealHeight,iconRealSize,iconRealSize),drawCanvas2Image()}}function changeElementVisible(e,a){e&&e.css("display",a?"block":"none")}function changeIconBannerVisible(e){$(".divider").css("visibility",e?"visible":"hidden"),$(".icon-banners").css("visibility",e?"visible":"hidden"),$(".icon-banners").css("height",e?"auto":"0")}function changeDownloadBtnVisible(e){$(".download-btn").css("visibility",e?"visible":"hidden")}function inputChangeListener(){$("#avatar").change(function(e){cropper&&(cropper.destroy(),changeElementVisible(copperImage,!1),changeElementVisible(preview,!1),changeElementVisible(container,!1),changeElementVisible(cropBtn,!1),changeElementVisible(image,!1),changeIconBannerVisible(!1),changeDownloadBtnVisible(!1));var a=e.target.files[0],n=new FileReader;n.readAsDataURL(a),n.onload=function(e){changeElementVisible(copperImage,!0),changeElementVisible(preview,!0),changeElementVisible(container,!0),changeElementVisible(cropBtn,!0);var a=n.result;copperImage[0].src=a,cropper&&cropper.destroy(),cropper=new Cropper(copperImage[0],{aspectRatio:1,minContainerWidth:300,minContainerHeight:300,autoCropArea:1,dragMode:"move"})}})}function iconClickListener(){$(".icon-banners").click(function(e){"IMG"===e.target.nodeName&&drawIcon(e.target.src,pixelRatio)})}function cropperBtnClickListener(){cropBtn.on("click",function(e){cropper&&(drawAvatar(cropper.getCroppedCanvas().toDataURL()),changeElementVisible(preview,!1),changeElementVisible(container,!1),changeElementVisible(cropBtn,!1)),console.log("cropperBtnClickListener")})}function getPixelRatio(e){var a=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/a}function downloadCanvasImg(){var e="image/png",a=canvas.toDataURL(e),n=document.createElement("a");n.download="JallowPinsAvatar",n.href=a,n.dataset.downloadurl=[e,n.download,n.href].join(":"),document.body.appendChild(n),n.click(),document.body.removeChild(n)}function downloadBtnListener(){$(".download-btn").click(downloadCanvasImg)}jQuery(function(){console.log("document ready"),inputChangeListener(),iconClickListener(),cropperBtnClickListener(),downloadBtnListener()});